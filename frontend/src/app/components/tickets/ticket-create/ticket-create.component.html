<div class="container">
    <div class="header-actions">
        <h2>Nouveau Ticket</h2>
        <a routerLink="/tickets" class="btn-secondary">Retour</a>
    </div>
    <div class="card glass-card">
        <div *ngIf="loading" class="loading-state">
            <div class="spinner"></div>
            <p>Chargement des projets...</p>
        </div>
        <form *ngIf="!loading && projets.length > 0; else noProjets" (ngSubmit)="f.form.valid && onSubmit()" #f="ngForm"
            novalidate>
            <div class="form-group">
                <label for="projetId">Projet Concerné</label>
                <select class="form-control" name="projetId" [(ngModel)]="form.projetId" required #prj="ngModel">
                    <option *ngFor="let p of projets" [value]="p.id">{{ p.nom }}</option>
                </select>
                <div class="alert-danger" *ngIf="prj.errors && f.submitted">
                    Le projet est requis
                </div>
            </div>
            <div class="form-group">
                <label for="titre">Sujet du Ticket</label>
                <input type="text" class="form-control" name="titre" [(ngModel)]="form.titre" required #titre="ngModel"
                    placeholder="Ex: Erreur 500 sur la page d'accueil" />
                <div class="alert-danger" *ngIf="titre.errors && f.submitted">
                    Le sujet est requis
                </div>
            </div>
            <div class="form-group">
                <label for="priorite">Priorité</label>
                <select class="form-control" name="priorite" [(ngModel)]="form.priorite" required>
                    <option value="BASSE">Basse</option>
                    <option value="MOYENNE">Moyenne</option>
                    <option value="HAUTE">Haute</option>
                    <option value="CRITIQUE">Critique</option>
                </select>
            </div>
            <div class="form-group">
                <label for="description">Description Détaillée</label>
                <textarea class="form-control" name="description" [(ngModel)]="form.description" rows="5" required
                    #desc="ngModel" placeholder="Décrivez le problème..."></textarea>
                <div class="alert-danger" *ngIf="desc.errors && f.submitted">
                    La description est requise
                </div>
            </div>
            <div class="form-group">
                <label for="files">Pièces jointes (optionnel)</label>
                <input type="file" class="form-control-file" id="files" (change)="onFileSelected($event)" multiple
                    accept="*/*" />
                <small class="form-text">Maximum 5 fichiers, 2 MB par fichier</small>
                <div class="selected-files" *ngIf="selectedFiles.length > 0">
                    <div class="file-item" *ngFor="let file of selectedFiles; let i = index">
                        <span class="file-name">{{ file.name }} ({{ (file.size / 1024).toFixed(2) }} KB)</span>
                        <button type="button" class="btn-remove" (click)="removeFile(i)">X</button>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary btn-block">Créer le Ticket</button>
            <div class="alert alert-danger" *ngIf="errorMessage">
                {{ errorMessage }}
            </div>
        </form>
        <ng-template #noProjets>
            <div class="alert alert-warning">
                Vous n'avez aucun projet actif. Veuillez contacter un administrateur pour qu'il vous crée un projet.
            </div>
        </ng-template>
    </div>
</div>